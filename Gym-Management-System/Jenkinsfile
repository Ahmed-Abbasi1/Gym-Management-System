pipeline {
    agent any
    
    environment {
        APP_REPO = 'https://github.com/Ahmed-Abbasi1/Gym-Management-System.git'
        TEST_REPO = 'https://github.com/Ahmed-Abbasi1/Gym-Management-System-Tests.git'
        DOCKER_IMAGE = 'itxjani/gym-backend:latest'
    }
    
    stages {
        stage('Checkout Application Code') {
            steps {
                echo 'Checking out application code from GitHub...'
                checkout scm
            }
        }
        
        stage('Build and Deploy Application') {
            steps {
                echo 'Building and deploying containerized application...'
                script {
                    sh '''
                        cd Gym-Management-System
                        
                        # Stop existing containers if running
                        docker-compose -f docker-compose-jenkins.yml down || true
                        
                        # Pull latest image from Docker Hub
                        docker pull ${DOCKER_IMAGE}
                        
                        # Start containers with volume-mounted code
                        docker-compose -f docker-compose-jenkins.yml up -d
                        
                        # Wait for containers to be healthy
                        sleep 15
                        
                        # Show running containers
                        docker-compose -f docker-compose-jenkins.yml ps
                    '''
                }
            }
        }
        
        stage('Checkout Test Code') {
            steps {
                echo 'Checking out test code from GitHub...'
                dir('tests-repo') {
                    git branch: 'main',
                        url: "${TEST_REPO}"
                }
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                echo 'Running Selenium tests in Docker container...'
                script {
                    sh '''
                        cd tests-repo
                        
                        # Build test Docker image
                        docker build -t gym-tests:latest .
                        
                        # Run tests in container
                        docker run --rm \
                            --name gym-selenium-tests \
                            -v $(pwd)/reports:/tests/reports \
                            gym-tests:latest \
                            pytest test_gym_app.py -v \
                            --html=reports/report.html \
                            --self-contained-html \
                            --junit-xml=reports/results.xml || true
                        
                        # Check if report was generated
                        ls -la reports/
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            steps {
                echo 'Verifying deployment...'
                script {
                    sh '''
                        # Check if all containers are running
                        docker ps | grep jenkins
                        echo "Application URLs:"
                        echo "Frontend: http://54.226.193.105:8081/"
                        echo "Backend API: http://54.226.193.105:4000/docs"
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'Publishing test results...'
            // Archive test reports
            archiveArtifacts artifacts: 'tests-repo/reports/**/*', allowEmptyArchive: true
            
            // Publish JUnit test results
            junit testResults: 'tests-repo/reports/results.xml', allowEmptyResults: true
            
            // Publish HTML report
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'tests-repo/reports',
                reportFiles: 'report.html',
                reportName: 'Selenium Test Report'
            ])
        }
        
        success {
            echo 'Pipeline completed successfully!'
            script {
                emailext (
                    subject: "Jenkins Build Successful - Build #${env.BUILD_NUMBER}",
                    body: "Build succeeded! Check test results at: ${env.BUILD_URL}",
                    to: "ahmedabassi093@gmail.com",
                    from: "ahmedabassi093@gmail.com",
                    replyTo: "ahmedabassi093@gmail.com"
                )
            }
        }
        
        failure {
            echo 'Pipeline failed!'
            script {
                emailext (
                    subject: "Jenkins Build Failed - Build #${env.BUILD_NUMBER}",
                    body: "Build failed! Check console at: ${env.BUILD_URL}console",
                    to: "ahmedabassi093@gmail.com",
                    from: "ahmedabassi093@gmail.com",
                    replyTo: "ahmedabassi093@gmail.com"
                )
            }
        }
    }
}
